<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electronativo</title>
</head>
<body  style="display: flex;">

    <div>
    <h1>Datos del archivo Excel</h1>

    <form action="/buscar" method="get">
        <input type="text" name="query" placeholder="Buscar por código o nombre">
        <button type="submit">Buscar</button>
    </form>
    <% cabecera.forEach(columna => { %>
        <th><%= columna %></th>
    <% }) %>
    <% datos.forEach((fila, index) => { %>
        <form action="/agregarPresupuesto" method="post">
           <input type="text" name="codigo" value="<%= fila[0] %>" readonly>
           <input type="text" name="nombre" value="<%= fila[1] %>" readonly>
           <input type="text" name="precio" value="<%= fila[2] %>" readonly>
           <input type="hidden" name="index" value="<%= index %>" readonly>
           <button type="submit">Cargar</button>
        </form>
     <% }) %>
    </div>

    <div>
            <!-- Información general -->
            <label>Numero Presupuesto:</label>
            <input type="text">
            
            <label>Fecha:</label>
            <input type="date">
            
            <label>Apellido y Nombre/Razon Social:</label>
            <input type="text">
            
            <label>Domicilio:</label>
            <input type="text">
            <table>
                <thead>
                    <tr>
                        <th>Codigo</th>
                        <th>Nombre</th>
                        <th>Precio Unitario</th>
                        <th>Cantidad</th>
                        <th>Precio total</th>
                        <th>Accion</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (presupuestoActual && presupuestoActual.length > 0) { %>
                        <% presupuestoActual.forEach(producto => { %>
                            <tr>
                                <form action="/retirarItem" method="post">
                                <td><input type="text" name="codigo" value="<%= producto.codigo || '' %>" readonly></td>
                                <td><input type="text" name="nombre" value="<%= producto.nombre || '' %>" readonly></td>
                                <td><input type="text" name="precio" value="<%= producto.precio || '' %>" readonly></td>
                                <td>
                                    <input type="number" name="cantidad" value="0" oninput="actualizarPrecioTotal(this)">
                                    <button type="button" onclick="aumentar(this)">+</button>
                                    <button type="button" onclick="disminuir(this)">-</button>
                                    
                                </td>
                                <td><input type="text" name="precioTotal" value="0.00" readonly></td>
                                <input type="hidden" name="index" value="<%= producto.index || '' %>" readonly>
                                <td><button type="submit"> Eliminar</button></td>
                               </form>
                            </tr>
                        <% }) %>
                    <% } else { %>
                        <tr>
                            <td colspan="3">Esperando productos...</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>

                 <!-- Total Section -->
        <div style="font-weight: bold; margin-top: 20px;">
            <label>Total: </label>
            <span id="total">0.00</span>
        </div>
    </div>
    <% if (alertMessage) { %>
        <div style=" 
            background-color: #bd0010;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            text-align: center;
            z-index: 1000;
        ">
            <%= alertMessage %>
        </div>
    <% } %>

    <script>
            // Evitar que presionar Enter envíe el formulario
            document.querySelectorAll('form').forEach(form => {
            form.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Evita que el formulario se envíe
                }
            });
        });

        function aumentar(boton) {
            let inputCantidad = boton.parentElement.querySelector('input[name="cantidad"]');
            let cantidad = parseInt(inputCantidad.value) + 1;
            inputCantidad.value = cantidad;
            actualizarPrecioTotal(boton);
        }

        function disminuir(boton) {
            let inputCantidad = boton.parentElement.querySelector('input[name="cantidad"]');
            let cantidad = Math.max(0, parseInt(inputCantidad.value) - 1);
            inputCantidad.value = cantidad;
            actualizarPrecioTotal(boton);
        }
        function actualizarPrecioTotal(boton) {
    let inputCantidad = boton.parentElement.querySelector('input[name="cantidad"]');
    let cantidad = parseInt(inputCantidad.value);

    // Verificar si la cantidad es negativa
    if (cantidad < 0) {
        alert("Error: La cantidad no puede ser negativa.");
        inputCantidad.value = 0; // Reiniciar a 0
        cantidad = 0; // Reiniciar la cantidad a 0 para evitar cálculo incorrecto
    }

    let inputPrecioUnitario = boton.closest('tr').querySelector('input[name="precio"]');
    let precioUnitario = parseFloat(inputPrecioUnitario.value);

    let inputPrecioTotal = boton.closest('tr').querySelector('input[name="precioTotal"]');
    inputPrecioTotal.value = (cantidad * precioUnitario).toFixed(2);

    // Actualizar el total
    actualizarTotal();
}

function actualizarTotal() {
    let total = 0;
    document.querySelectorAll('input[name="precioTotal"]').forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('total').textContent = total.toFixed(2);
}
    </script>

</body>
</html>